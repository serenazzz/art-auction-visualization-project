<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Art Auction Visualization</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://d3js.org/d3.v4.min.js"></script>
  </head>
  <style>
    .left {
      float: left;
    }
    .padding {
      padding: 0 10px;
    }
    .color {
      padding: 0 20px;
    }
    .blue {
      color: blue;
    }
    .red {
      color: red;
    }
    .green {
      color: green;
    }
    .yellow {
      color: yellow;
    }
    .orange {
      color: orange;
    }
    .fuchsia {
      color: fuchsia;
    }
    .aqua {
      color: aqua;
    }
    .maroon {
      color: maroon;
    }
    .glyphicon-stop {
      padding-right: 2px;
    }
    #color-key {
      margin-left: 100px;
      text-align: center;
    }
    #title {
      margin-left: 150px;
    }
    #subtext {
      margin-left: 175px;
    }
    #jitter {
      margin: 35px 0 0 20px;
    }
    #checkbox {
      margin: 0 5px 0 0;
    }
  </style>
  <body>

  <div class="container">
    <div class="row">
      <div class="col-xs-12">
        <div class="row">
          <div class="col-xs-6">
            <h1 id="title" class="left">Art Auction Visualization</h1>
          </div>
          <div class="col-xs-2">
            <h4 id="jitter"><input type="checkbox" id="checkbox"> Add jitter</h4>
          </div>
          <div class="col-xs-4">
            <h1 id="scroll_left" class="glyphicon glyphicon-chevron-left left padding"></h1>
            <h1 class="left" id="current-year"></h1>
            <h1 id="scroll_right" class="glyphicon glyphicon-chevron-right left padding"></h1>
          </div>
        </div>
        <div class="row">
          <p id="subtext" class="left"><b>Hammer Prices by Year (USD, 2006-2018)</b></p>
        </div>
        <div class="row">
          <div id="color-key"></div>
        </div>
        <div id="timeline"></div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>
  <script>
    // This is not related to d3, I'm just conveniently using d3 to read
    // my json file for firebase configuration credentials
    d3.json("config.json", function(error, data) {
      // Initialize Firebase
      var config = data;
      firebase.initializeApp(config);
    });
  </script>
  <script>
  // Create svg and initial circles
  var w = 1200;
  var h = 800;
  var margin = {top: 25, right: 175, bottom: 250, left: 100};
  var innerWidth = w - margin.left - margin.right;
  var innerHeight = h - margin.top - margin.bottom;

  var currentYear = 2017
  document.getElementById("current-year").innerHTML = currentYear;

  // for formmating numbers with commas
  const addCommas = (x) => {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  var svg = d3.select("#timeline")
    .append("svg")
    .attr("width", w)
    .attr("height", h);

  svg.append("rect")
    .attr("x", margin.left - 75)
    .attr("y", margin.top - 25)
    .attr("width", innerWidth + 150)
    .attr("height", innerHeight + 50)
    .attr("fill", "gray")
    .attr("fill-opacity", .05);

  d3.json("interactive.json", function(error, data) {

    // filter initial data based on year
    var displayData = data.filter(function(lot) {
      return lot.auc_year == currentYear;
    });

    // set axes scales
    var xScale = d3.scaleLinear()
      .domain([new Date(currentYear, 0, 1), new Date(currentYear, 11, 31)])
      .range([0, innerWidth])

    var yScale = d3.scaleLog()
      .domain([1, d3.max(displayData, d => d.hammer_price_bp_usd)])
      .range([innerHeight, 0]);

    var xAxis = d3.axisBottom()
      .scale(xScale)
      .ticks(6)
      .tickFormat(d3.timeFormat("%B"))

    var yAxis = d3.axisLeft()
      .scale(yScale)
      .tickFormat(function (d) {
        return yScale.tickFormat(4, d3.format("$,d"))(d)});

    // Add initial circles
    var colorMap = [{"location": "NEW YORK", "color": "blue"},
                    {"location": "LONDON", "color": "red"},
                    {"location": "PARIS", "color": "green"},
                    {"location": "AMSTERDAM", "color": "yellow"},
                    {"location": "MILAN", "color": "orange"},
                    {"location": "HONG KONG", "color": "fuchsia"},
                    {"location": "DOHA", "color": "aqua"},
                    {"location": "DUBAI", "color": "maroon"}];

    var html = colorMap.map(function(src) {
      return '<div class="left color"><span class="glyphicon glyphicon-stop ' + src.color + '"></span>' + src.location + '</div>';
    }).join('');

    document.getElementById("color-key").innerHTML = html;

    var circles = svg.selectAll("circles").data(displayData);

    circles.enter().append("circle")
      .attr("cx", d => xScale(new Date(d.auc_date)))
      .attr("transform", `translate (${margin.left}, ${margin.top})`)
      .attr("cy", d => yScale(d.hammer_price_bp_usd + 1))
      // .attr("transform", `translate (${margin.left}, ${h - margin.bottom})`)
      .attr("r", 2.5)
      .attr("fill", d => colorMap.find(function (obj) { return obj.location === d.location; }).color || "black");

    var yearAvg = [ {"year": 2006, "avg": 87349.239381},
                    {"year": 2007, "avg": 136806.983869},
                    {"year": 2008, "avg": 0},
                    {"year": 2009, "avg": 165440.944540},
                    {"year": 2010, "avg": 246727.238122},
                    {"year": 2011, "avg": 123318.565553},
                    {"year": 2012, "avg": 222119.085527},
                    {"year": 2013, "avg": 488812.895422},
                    {"year": 2014, "avg": 466449.762520},
                    {"year": 2015, "avg": 613052.839521},
                    {"year": 2016, "avg": 217353.244371},
                    {"year": 2017, "avg": 294252.180225},
                    {"year": 2018, "avg": 607385.137199}]

    svg.append("line")
      .attr("class", "average")
      .style("stroke", "black")
      .attr("stroke-width", "2px")
      .attr("x1", margin.left)     // x position of the first end of the line
      .attr("y1", yScale(yearAvg.find(function (obj) {return obj.year === currentYear;}).avg))
      .attr("x2", innerWidth + 100)     // x position of the second end of the line
      .attr("y2", yScale(yearAvg.find(function (obj) {return obj.year === currentYear;}).avg))

    var averagePrice = yearAvg.find(function (obj) {return obj.year === currentYear;}).avg

    svg.append("text")
      .attr("class", "avg-text")
      .attr("x", innerWidth + 103)
      .attr("y", yScale(averagePrice)-5)
      .text("Average: ");

    svg.append("text")
      .attr("class", "avg-qty")
      .attr("x", innerWidth + 103)
      .attr("y", yScale(averagePrice)+10)
      .text("$" + addCommas(Math.round(averagePrice)));

    // append axes
    svg.append("g")
      .attr("class", "xAxis")
      .attr("transform", `translate (${margin.left}, ${h - margin.bottom})`)
      .call(xAxis);
    svg.append("g")
      .attr("class", "yAxis")
      .attr("transform", `translate (${margin.left}, ${margin.top})`)
      .call(yAxis);

    // General Update Pattern
    function updateDataTo(year, enterPos, exitPos) {

      delay = 300

      document.getElementById("current-year").innerHTML = year;

      var newData = data.filter(function(lot) {
        return lot.auc_year == year;
      });

      // update y axis scale
      var xScale = d3.scaleLinear()
        .domain([new Date(year, 0, 1), new Date(year, 11, 31)])
        .range([0, innerWidth])

      var yScale = d3.scaleLog()
        .domain([1, d3.max(newData, d => d.hammer_price_bp_usd + 1)])
        .range([innerHeight, 0]);

      var xAxis = d3.axisBottom()
        .scale(xScale)
        .ticks(6)
        .tickFormat(d3.timeFormat("%B"))

      var yAxis = d3.axisLeft()
        .scale(yScale)
        .tickFormat(function (d) {
        return yScale.tickFormat(4, d3.format("$,d"))(d)});

      // first remove old data
      var circles = svg.selectAll("circle").data([]);

      circles.exit()
        .transition()
        .duration(delay)
        .attr("cx", exitPos)
        .remove();

      // then update new data
      circles = svg.selectAll("circles").data(newData);

      circles.enter().append("circle")
        .attr("cx", enterPos)
        .attr("transform", `translate (${margin.left}, ${margin.top})`)
        .attr("cy", d => yScale(d.hammer_price_bp_usd + 1))
        // .attr("transform", `translate (${margin.left}, ${h - margin.bottom})`)
        .attr("r", 2.5)
        .attr("fill", d => colorMap.find(function (obj) { return obj.location === d.location; }).color || "black")
        .merge(circles)
        .transition()
        .duration(delay)
        .ease(d3.easeLinear)
        .attr("cx", d => xScale(new Date(d.auc_date)))
        .attr("transform", `translate (${margin.left}, ${margin.top})`)
        .attr("cy", d => yScale(d.hammer_price_bp_usd + 1))

      var averagePrice = yearAvg.find(function (obj) {return obj.year === year;}).avg

      svg.select(".average")
        .transition()
        .duration(delay)
        .style("stroke", "black")
        .attr("stroke-width", "2px")
        .attr("x1", margin.left)     // x position of the first end of the line
        .attr("y1", yScale(averagePrice))
        .attr("x2", innerWidth + 100)     // x position of the second end of the line
        .attr("y2", yScale(averagePrice));

      svg.select(".avg-text")
        .transition()
        .duration(delay)
        .attr("x", innerWidth + 103)
        .attr("y", yScale(averagePrice)-5)
        .text("Average: ");

      svg.select(".avg-qty")
        .transition()
        .duration(delay)
        .attr("x", innerWidth + 103)
        .attr("y", yScale(averagePrice)+10)
        .text("$" + addCommas(Math.round(averagePrice)));

      svg.select(".yAxis")
        .transition()
          .duration(delay)
          .ease(d3.easeLinear)
          .call(yAxis);

      // show lot image on mouse over, remove on mouse out
      d3.selectAll("circle").on("mouseover", function(d, i) {
        svg.append("svg:image")
          .attr("class", "lot-image")
          .attr("x", xScale(new Date(d.auc_date)) + 10)
          .attr("transform", `translate (${margin.left}, ${margin.top})`)
          .attr("y", yScale(d.hammer_price_bp_usd + 1) + 10)
          .attr("width", 200)
          .attr("height", 200)
          .attr("xlink:href", d.external_image_url)

        svg.append("text")
          .attr("class", "price-text")
          .attr("x", xScale(new Date(d.auc_date)) + 75)
          .attr("transform", `translate (${margin.left}, ${margin.top})`)
          .attr("y", yScale(d.hammer_price_bp_usd + 1) + 5)
          .attr("text-decoration", "underline")
          .text("$" + addCommas(Math.round(d.hammer_price_bp_usd)));

      }).on("mouseout", function(d, i) {
        d3.select(".lot-image").remove();
        d3.select(".price-text").remove();
      });
    }

    // check which arrow was clicked and update accordingly
    d3.selectAll("h1").on("click", function () {
      var arrow = d3.select(this).attr("id");
      var l_side = 0;
      var r_side = innerWidth + 75;

      if (arrow == "scroll_right") {
        currentYear += 1
        if(currentYear > 2018)
          currentYear = 2018
        else
          updateDataTo(currentYear, r_side, l_side)
      } else if (arrow == "scroll_left") {
        currentYear -= 1
        if(currentYear < 2006)
          currentYear = 2006
        else
          updateDataTo(currentYear, l_side, r_side)
      }
    });

    // show lot image on mouse over, remove on mouse out
    d3.selectAll("circle").on("mouseover", function(d, i) {
      svg.append("svg:image")
        .attr("class", "lot-image")
        .attr("x", xScale(new Date(d.auc_date)) + 10)
        .attr("transform", `translate (${margin.left}, ${margin.top})`)
        .attr("y", yScale(d.hammer_price_bp_usd + 1) + 10)
        .attr("width", 200)
        .attr("height", 200)
        .attr("xlink:href", d.external_image_url)

      svg.append("text")
        .attr("class", "price-text")
        .attr("x", xScale(new Date(d.auc_date)) + 75)
        .attr("transform", `translate (${margin.left}, ${margin.top})`)
        .attr("y", yScale(d.hammer_price_bp_usd + 1) + 5)
        .attr("text-decoration", "underline")
        .text("$" + addCommas(Math.round(d.hammer_price_bp_usd)));

    }).on("mouseout", function(d, i) {
      d3.select(".lot-image").remove();
      d3.select(".price-text").remove();
    });

    var jitter = false;
    d3.select("#checkbox").on("change",addJitter);

    function addJitter(){
      jitter = !jitter;

      circles = svg.selectAll("circle");

      // update y axis scale
      var xScale = d3.scaleLinear()
        .domain([new Date(currentYear, 0, 1), new Date(currentYear, 11, 31)])
        .range([0, innerWidth])

      if(jitter) {
        circles.attr("cx", d => xScale(new Date(d.auc_date)) + randInRange(-1, 1)*30)
      } else {
        circles.attr("cx", d => xScale(new Date(d.auc_date)))
      }

      // Returns a random number between min (inclusive) and max (exclusive)
      function randInRange(min, max) {
          return Math.random() * (max - min) + min;
      }
    }

  });

  </script>

  </body>
</html>






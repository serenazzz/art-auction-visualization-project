---
title: "Art Project EDAV"
author: "Alexandra Sudomoeva, Elizabet Doliar, Serena Zhang, Basil Vetas"
date: "4/26/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = TRUE)
library(tidyverse)
library(lattice)
library(DAAG)
library(tidyr)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(grid)
```


# Introduction

### Introduction

For our project we chose to perform an exploratory analysis and visualization on a dataset containing the historical auction prices of thousands of pieces of art. We chose this topic for a variety of reasons---whether you come from the arts and humanities, or economics and finance, art is an interesting and complex field. With new data starting to become available, for the first time we have the ability to analyze and better understand this historically opaque industry. It is a potential treasure trove for data scientists.

For hundreds of years fine art has been valued by cultures throughout the world for its aesthetic and beauty, but fine art as an asset class also appeals to many people today as an attractive alternative investment that is largely non-correlated to the traditional stock market. The fine art asset class is estimated to have a global market value of over $60 billion in annual turnover and has historically outperformed the S&P 500 in terms of compound annual growth (specifically, 15-year CAGR). Geographically, the art market has for decades been dominated by the United States, United Kingdom and China with the greatest concentration of art sales in the entire world occurring right here in New York City.

Each of our team members has a diverse background. In addition to experience as data scientists, a few of us have a background in economics and have worked for financial services and tech  companies. A few of us have also worked in the art industry for galleries or collectors. This topic was a cross-section of our experiences and interests that allowed us to explore timely questions about the prices and dynamics of the fine art market.

From a high level, the questions that intrigued us most were related to knowing more about the auction prices (called hammer price) for pieces of art in terms of different artists, location and time periods. We initially developed a large list of potential questions, and narrowed these down based on viability in terms of the data we had available as well as the scope and time constraints for the project. Some of the specific questions we decided to look at are:

1. What is the distribution of quantity of lots and auctions by location, year, and season?
2. What are the lot titles that have higher price or appear more?
3. How is price related to artist’s era/when he/she was born?
4. Do auction prices vary by location and season?
5. Did Financial Crisis have any effect on the auctions?
6. Does the order in which the lot is presented affect the overall sell price?


### Team Members & Contributions

Each team meber worked equally hard to bring this project to live. While having weekly progress meetings and brainstorming sessions, we have adopted a divide and concour approach around building graphs and the corresponding write-up. 

Introduction as well as Data Description were written by *Basil Vetas*. As a full time employee of Arthena, Basil was also intrumential in helping us collect the dataset used in the project. In addition, Basil worked on the interactive component of the assignment.

Data Quality analysis as well as some of the clean-up was performed by *Alexandra Sudomoeva*. Alexandra also built visualizations for the Financial Crisis' impact in the main analysis. Lastly, she assisted in writing the instructions for the interactive component. 

*Serena Zhang* worked on data preprocessing and the main analysis as well as the executive summary. Her analysis included auction price correlation with lot titles, artist's era, order in auction, season and location. 

The main contributor to the analysis around basic information was *Elizabet Doliar*. She also worked at analyzing project titles and creating an auction price summary by building a parrallel coordinates plot. Lastly, Elizabet helped put together the executive summary.


# Data Description

### Overview

This dataset was provided by Arthena (https://arthena.com/). It was sourced from Sotheby’s historical auction data via the scraping of public web pages.  The raw dataset includes 22711 rows of data. Each row represents an individual lot from an auction (a lot could be an individual painting, a sculpture, or sometimes even a collection of works).  The raw dataset includes 25 columns of data.  Each column represents a feature related to either that specific lot, the artist of the lot, or the auction where the lot was sold.  Column definitions are listed below by category (Lot, Auction or Artist). For our analysis we also derive new columns from the original raw dataset. The derived column definitions are also listed below. Including these columns we ended with a total of 43 columns of data.  The detailed logic and thought process is described more in the 'Data Quality Analysis' section.

```{r}
#Read data
art_df = read.csv("final_sothebys.csv", header=TRUE, na.strings=c("", NA))
```

### Column Definitions:

```{r}
#Dropping features with no interest (non-informative) in the analysis
drop <- c("X", "Unnamed..0", "provenance", "auc_desc", "auction_house_id", "external_image_url", "literature", "end_date")
art_df <- art_df[, !(names(art_df) %in% drop)]
```

**Lot**  
lot_id: a unique id for each lot. <br/>
lot_title: the title of the lot. A lot can sometimes consist of multiple pieces of art. We assume that 1 piece is 1 lot since that is most common. <br/> 
estimate_low: the low-end auction price estimate for a lot, given by Sothebys.  <br/>
estimate_high: the high-end auction price estimate for a lot, given by Sothebys. <br/>  
hammer_price_bp: how much the lot was sold for at auction, plus buyers premium (a percentage fee taken by Sothebys and paid by the buyer). <br/>
currency: currency denomination for the price estimates and hammer price (limited to USD, EUR, GBP, HKD).  <br/>
nth_in_auction: the order that the lot was presented in at auction.  <br/>
lot_number: a number assigned to a lot for the given auction, different than nth_in_auction.  <br/>
condition: description of the condition of the lot (messy text field - not used for our analysis).  <br/>
provenance: description of who owned the lot previously (messy text field - not used for our analysis). <br/> 
literature:  different publications that the lot was mentioned in (messy text field - not used for our analysis).  <br/>
external_image_url: link to the image (not used for our analysis).

**Auction**  
auction_house_id: unique id for each auction house (for this dataset, all 1 since we are only using Sothebys data).  <br/>
auction_id: unique id for each auction.  
auc_title: title of the auction.  <br/>
number_of_lots: total number of lots in the auction.  <br/>
location: location where the auction was held.  <br/>
start_date: start date of the auction.  <br/>
end_date: end date of the auction (same as start date for this dataset).  <br/>
auc_desc: description of the auction (messy text field - not used for our analysis). <br/>  
sale_id: unique auction sale id assigned by Sothebys.  <br/>

**Artist**  
artist_id: unique id for each artist. <br/> 
name: name of the artist.  <br/>
birth_year: artist’s approximate birth year  (messy text field - not used for our analysis).  <br/>
death_year: artist’s approximate death year  (messy text field - not used for our analysis).  <br/>

**Derived**  
estimate_avg: the average between estimate_low and estimate_high.  <br/>
is_untitled: an indicator variable whether the name of the lot is "untitled" (in some language).  <br/>
auc_year: the year of the auction (YYYY format).  <br/>
auc_month: the month of the auction (as integers 1-12).  <br/>
auc_season: the season of the auction (as integers 1-4).  <br/>
auc_date: the date of the auction.  <br/>
auth_era: groupe the birth year of authors into 10-year perios <br/>
nth_in_auction: the order in the auction by quantiles (as integers 1-100).  <br/>
percent_in_auction: the percentage through an auction that a lot was shown (nth_in_auction divided by number_of_lots).  <br/>
hammer_price_bp_usd: hammer_price_bp converted to usd.  <br/>
estimate_high_usd: estimate_high converted to usd. <br/> 
estimate_low_usd: estimate_low converted to usd.  <br/>
estimate_avg_usd: estimate_avg converted to usd.  <br/>
hammer_price_bp_usd_range: factor of bucketed hammer price ranges in usd.  <br/>


# Data Quality Analysis

## Preprocessing

In this part of the project, we will be exploring the quality of the data provided for the auction data. Before analyzing the overall quality, a simple preprocessing has been conducted in Python that included the following steps:

1. Since 'Start Date' and 'End Date' are always the same within the dataset, we decided to only use 'Start Date' for the time when the auction occurred. Converted the column to DateTime type.
2. Based on 'Start Date' column, we added columns for normalized year, month, and season.
3. The "Title" column accepted a varity of title across different languages. We added a new column to indicate whether the piece is "untitled" while checking for the top 5 most common languages used: Italian, Dutch, English, French, Spanish, German.
4. Created a new column 'nth_in_auction' that would break the order of the auction into 100 tiles and a column 'percent_in_auction' to show the percentage of the order within a specific auction.
5. Added 'Average Estimate' column to reflect the average price estimation between the high and the low
6. Added column 'auth_era' to group author's birth year for every 10 years.
7. Converted all currency to USD to be able to compare pieces sold across different locations. We matched the exchange rate at the time of the sell to properly convert all transactions.
8. Added 'hammer_price_bp_usd_range' that allocates the hammer prices into 4 ranges.

A complete logic with code can be found here: https://github.com/serenazzz/art-auction-visualizatoin-project/blob/master/Preprocessing_final.ipynb


## Data Quality Exploration

Let us start by looking at all the missing values and if there are any general patterns. Since we are dealing with a large amount of rows, we will reduce repeated patterns to one row using the visna function. 

```{r fig.height=3.5}
#install.packages("extracat")
library(extracat)
visna(art_df, sort= "b")
```

Looking at the output above, we can conclude that the overall state of the dataset is relatively good. The second most common pattern has no missing values while the two most "problematic" features appear to be death_year and birth_year.

One important observation we will need to be careful about during further analysis is a relatively significant amount of missing values under hammer_price_bp feature. We have explored qualitative reasons behind the missing values in that category with the provider of the data. After careful observation, we found out that the missing values are actually driven by two locations that might have less strict regulations around data governance (Doha, Hong Kong). This observation is outlined in the graph below.


```{r}
#install.packages("viridis")
library(viridis)
art_location <- art_df %>% gather(attribute, value, -location) %>% mutate(missing = ifelse(is.na(value), "yes", "no"))
ggplot(art_location, aes(x = location, y = attribute, fill = missing)) +
  geom_tile(color = "white") +
  ggtitle("Missing Values by Location") +
  xlab("Location") + ylab("Feature Name") +
  scale_fill_viridis(discrete=TRUE) +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

This map allows us to see that some features' missing values like hammer_price_bp, condition, and birth year are actually only missing in certain location (typically in pairs of two). Therefore, we can speculate that this data is MAR (missing at random) depending on a location feature.

Indeed, when looking at the table below, the overall percentage of missing values across different locations varies quite significantly. Amsterdam is the top location with most missing values (8% of total).

```{r}
art_location <- art_df %>% gather(attribute, value, -location)
percent_missing <- art_location %>% group_by(location) %>%
  summarise(num_na = sum(is.na(value)), total = n()) %>%
  mutate(percent_na = num_na/total)%>%
  arrange(-percent_na)
percent_missing
```

This leads to a logical question. Are there any other variables that could explain the missing data? Therefore, we also looked at similar graphs while grouping by year and month.

```{r fig.width=7 }
art_year <- art_df %>% gather(attribute, value, -auc_year) %>% mutate(missing = ifelse(is.na(value), "yes", "no"))
year <- ggplot(art_year, aes(x = factor(auc_year), y = attribute, fill = missing)) +
  geom_tile(color = "white") + 
  ggtitle("Missing Values by Year") +
  xlab("Year") + ylab("Feature Name") +
  scale_fill_viridis(discrete=TRUE) +
  theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1))
art_month <- art_df %>% gather(attribute, value, -auc_month) %>% mutate(missing = ifelse(is.na(value), "yes", "no"))
month <-ggplot(art_month, aes(x = factor(auc_month), y = attribute, fill =       
                                missing)) +
  geom_tile(color = "white") + 
  ggtitle("Missing Values by Month") +
  xlab("Month") + ylab("Feature Name") +
  scale_fill_viridis(discrete=TRUE) +
  theme_bw()+theme(axis.text.x = element_text(angle = 45, hjust = 1))
grid.arrange(year, month, nrow=1)
```

While month looks more or less equally distributed (except hammer price), there is an interesting pattern forming in the year view. It comes as no surprise that older years (2006-2009) would carry a lot of the missing values for features around description and condition. There also looks to be certain years (more like 3 year periods) with perfectly clean data: 2010-2012 and 2015-2017. 

Next, let us look at the exact percentages and values for the overall missing data.

```{r}
#install.packages("skimr")
library(skimr)
skimr::skim(art_df) %>% filter(stat =="missing") %>% arrange(desc(value)) %>% select(variable, value) %>% mutate(percent = value/nrow(art_df)) %>% filter (percent>0)
```

Looking at the table, death and birth year are missing more than 25% of their data. More importantly, hammer_price is missing nearly 20%. Based on what we saw when looking by location, our guess is that some auction ids are missing the hammer_price_bp in its entirety and hence the difference. It can be easily checked by looking at the aggregate table. 

```{r}
art_price <- art_df[, c("auction_id", "hammer_price_bp")]
percent_missing <- art_price %>% group_by(auction_id) %>%
  summarise(num_na = sum(is.na(hammer_price_bp)), total = n()) %>%
  mutate(percent_na = num_na/total)%>%
  arrange(-percent_na)
percent_missing %>% filter(percent_na>=0.4)
```

Looking at the data table, there is a significant number of auctions that are missing more than 40% of the price data (sometimes even 100%). Therefore, it must be that not only the locations but also the auction itself is a determining factor in missing hammer price value. 

Lastly, we would like to check for correlation between average hammer_price_bp and percentage of missing values (since it is the one feature that matters the most in our analysis and is most prime to such correlations). Could it be that very high/low lots are simply not reported and, therefore, are missing more?

```{r}
art_auction <- art_df[, c("auction_id", "hammer_price_bp")] %>% arrange(auction_id)
art_average <-art_auction %>% filter(!is.na(hammer_price_bp)) %>% 
  group_by(auction_id) %>% summarise(mean =mean(hammer_price_bp)) %>% arrange(auction_id)
percent_missing <- percent_missing %>% arrange(auction_id)
add_2 <- data.frame(auction_id=2, mean=0)
add_3 <- data.frame(auction_id=3, mean=0)
art_average <- rbind(art_average, add_2)
art_average <- rbind(art_average, add_3) %>% arrange(auction_id)
percent <- percent_missing[4]
average <- art_average[2]
auction_id <- percent_missing[1]
corr <- data.frame(auction_id=auction_id, percent=percent, average = average)
ggplot(corr, aes(average, percent)) + geom_point(col="blue") +ggtitle("Auction Average Hammer Price vs Percentage of Missing Values") +
  scale_x_log10( breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x)))
```

There does not seem to be very strong correlation between the two variables. Just a subtle suggestion that auctions with smaller average price tend to have more NAs. Therefore, we will only consider location as the main determinant for missing values around hammer_price_bp. 

Before we move on, let us quickly follow up on the action items from the data quality analysis. 

1. filter out NAs for price estimates
2. take a note to exclude Doha and Hong Kong fro hammer_price_bp analysis

```{r}
# construct final dataset based on the quality analysis
art_final <- art_df %>% filter(!is.na(estimate_low)) %>%
            drop_na(hammer_price_bp_usd) %>%
          filter(location %in%  c("NEW YORK", "LONDON", "PARIS", "MILAN","DUBAI","AMSTERDAM"))
```

# Main Analysis (Exploratory Data Analysis)

Our research can be divided into three sections:
General questions about the auction information, understanding fluctuations in lot prices and deriving general conclusion. 

## General Auction Information

We started by asking many questions about possible relationships between variables. The first set of plots will explore the correlation between number of lots sold and year, location and season. We were hoping to notice meaningful trends that can be further explored in subsequent sections. Since we had only a few locations, seasons and years we chose a barchart and excluded duplicate rows by the 'number of lots' column.

```{r fig.height = 4, fig.width = 8}
library(gridExtra)
##Lots by location
art_info <- subset(art_final, select=c( "location", "number_of_lots" ))
art_info <- art_info[!duplicated(art_info$number_of_lots),]
art_group <- art_info %>% group_by(location)%>% summarise(B=sum(number_of_lots)) 
p1 <- ggplot(art_group, aes(x= location, y = B)) + 
    geom_bar( stat='identity', color="royalblue", fill="grey")  +labs(x = "Location")+labs(y = "Total number of lots") + ggtitle("Number of lots sold by location")  + theme_minimal() + theme(plot.title = element_text(hjust = 0.5,face="bold"))

art_info2 <- subset(art_final, select=c( "auc_year", "number_of_lots" ))
art_info2 <- art_info2[!duplicated(art_info2$number_of_lots),]
art_info2 <- art_info2 %>% group_by(auc_year)%>% summarise(B=sum(number_of_lots)) 
p2 <- ggplot(art_info2, aes(x= auc_year, y = B)) + 
    geom_bar( stat='identity', color="royalblue", fill="grey")  +labs(x = "Auction year")+labs(y = "Total number of lots") + ggtitle("Number of lots sold by year")  + theme_minimal()+ theme(plot.title = element_text(hjust = 0.5,face="bold"))+ scale_x_continuous(breaks= c(2006, 2010, 2014, 2017))

grid.arrange(p1, p2, nrow = 1)

```

```{r}
##Lots by season
art_info <- subset(art_final, select=c( "auc_season", "number_of_lots" ))
art_info <- art_info[!duplicated(art_info$number_of_lots),]
art_group <- art_info %>% group_by(auc_season)%>% summarise(B=sum(number_of_lots)) 
ggplot(art_group, aes(x= auc_season, y = B)) + 
    geom_bar( stat='identity', color="royalblue", fill="grey")  +labs(x = "Auction season")+labs(y = "Total number of lots") + ggtitle("Number of lots sold by season") + theme_minimal() + theme(plot.title = element_text(hjust = 0.5,face="bold"))  
```

Graphs above suggest that fall and spring are the most popular seasons to acquire a masterpiece. At the same time, there was a significant increase in number of lots sold since 2010, suggesting that investors started to see the art market as a form of long-term non-liquid investment after the financial crisis of 2008 (we will explore this hypothesis in more detail later in the analysis). The main hubs for art exchanges formed in London, New York and Paris.

The next set of graphs will focus on the number of actions by year, locaion and season.

```{r fig.height =4, fig.width = 8}
##Auctions by location, year, season
art_info <- subset(art_final, select=c( "auction_id", "location" ))
art_info <- art_info[!duplicated(art_info$auction_id),]
art_group <- art_info %>% group_by(location)%>% count(auction_id) %>% summarise(B=sum(n)) 
p1<-ggplot(art_group, aes(x= location, y = B)) + 
    geom_bar( stat='identity', color="royalblue", fill="grey")  +labs(x = "Auction location")+labs(y = "Number of auctions") + ggtitle("Number of auctions by location") + theme_minimal()+ theme(plot.title = element_text(hjust = 0.5,face="bold"))  

art_info2 <- subset(art_final, select=c( "auction_id", "auc_year" ))
art_info2 <- art_info2[!duplicated(art_info2$auction_id),]
art_info2 <- art_info2 %>% group_by(auc_year)%>% count(auction_id) %>% summarise(B=sum(n)) 

p2<- ggplot(art_info2, aes(x= auc_year, y = B)) + 
    geom_bar( stat='identity', color="royalblue", fill="grey")+labs(y = "Number of auctions")+labs(x = "Year") + theme_minimal() + ggtitle("Number of auctions by year") + theme(plot.title = element_text(hjust = 0.5,face="bold"))  
grid.arrange(p1, p2, nrow = 1)
```

```{r}
##Auctions by season
art_info <- subset(art_final, select=c( "auction_id", "auc_season" ))
art_info <- art_info[!duplicated(art_info$auction_id),]
art_group <- art_info %>% group_by(auc_season)%>% count(auction_id) %>% summarise(B=sum(n)) 
ggplot(art_group, aes(x= auc_season, y = B)) + 
    geom_bar( stat='identity', color="royalblue", fill="grey")  +labs(x = "Auction season")+labs(y = "Number of auctions") + ggtitle("Number of auctions by season") + theme_minimal() + theme(plot.title = element_text(hjust = 0.5,face="bold"))  
```
 Plotting the number of auctions based on location, season and year turned out to have similar results to the previous section and confirmed ideas suggested above. Namely, fall and spring are the two main auction seasons. London, New York and Paris are the main locations for art trading. And after 2009 the number of auctions conducted yearly around the world increased significantly. 
 
 
To answer our second set of questions and see what are the different triggers of variability in art prices we decided to explore fluctuations in Hammer Prices. Therefore, we created a histogram with density curve to visualize the distribution of Hammer Price.

```{r}
##Hammer Price
ggplot(art_final, aes(x= hammer_price_bp_usd)) + geom_histogram(aes(y=..density..))  + geom_density(col="red") + xlim(0,1500000) + theme_minimal() +xlab("Price") +ylab("Density") +ggtitle("Hammer Price Distribution")+ theme(plot.title = element_text(hjust = 0.5,face="bold"))

```

Distribution of Hammer Price is skewed to the right and has a long tail. We believe the reason for this is various price ranges for different groups of lots sold on the market. Variability in price can be explained by difference in art geners (Contemporary vs Renaissance for example), quality, age and popularity of the artwork. These factors can distinguish a masterpiece sold for $135 million like "Portrait of Adele Bloch-Bauer" by Gustav Klimt and Untitled paitning by Mark Rothko sold for only 6.5 million. 

Constracting valuable models in the next parts of our research fully depend on the ability to manipulate hammer price in the right way. We decided to remove the outliers.

```{r}
art_final <-art_final%>%
          filter(abs(art_final$hammer_price_bp_usd - 
               median(art_final$hammer_price_bp_usd)) <=3*sd(art_final$hammer_price_bp_usd))

ggplot(art_final, aes(x= hammer_price_bp_usd)) + geom_histogram(aes(y=..density..))  + geom_density(col="green") + xlim(0,1500000)+ theme_minimal() +xlab("Price") +ylab("Density") +ggtitle("Hammer Price Distribution (New)")+ theme(plot.title = element_text(hjust = 0.5,face="bold"))
```

Adjusted hammer price brought our attention to distribution of revenue over time and location. For both plots we chose a bar chart. 

```{r fig.height = 4, fig.width = 8}

##revenue by location

MyData <- subset(art_final, select=c( "location", "auction_id", "hammer_price_bp_usd" ))


MyData5 <- MyData %>% group_by(location)%>% summarise(B=sum(hammer_price_bp_usd)) 


p1 <- ggplot(MyData5, aes(x= location, y = B)) + 
    geom_bar( stat='identity', color="yellow", fill="grey")+labs(y = "Auction Revenue")+labs(x = "Location") + ggtitle("Auction revenue by location") + theme_minimal() + theme(plot.title = element_text(hjust = 0.5,face="bold"))

##revenue by year

MyData_1 <- subset(art_final, select=c( "auc_year", "auction_id", "hammer_price_bp_usd" ))

MyData_1 <- MyData_1 %>% group_by(auc_year)%>% summarise(B=sum(hammer_price_bp_usd)) 

p2<-ggplot(MyData_1, aes(x= auc_year, y = B)) + 
    geom_bar(stat='identity', color="green", fill="grey")+labs(y = "Auction Revenue")+labs(x = "Year") + ggtitle("Auction revenue by year") + theme_minimal()  + theme(plot.title = element_text(hjust = 0.5,face="bold"))

grid.arrange(p1, p2, nrow = 1)

```

After the financial crisis world art revenues went up following the assumption that people saw art as a form of investment. In 2013 revenues declined again possibly due to a slow down in the art market and went back up in the following years. London and New York continue to lead the way as the main centers for the exchange of art.

Another question that we thought would help us explore the data - Variability of lots across auctions?

In the data we had 89 auctions varying in theme, concept and length. We were partcilarly interested in the genrs of the auctions that had the biggest number of lots. We created a clevelend dot plot and filtered by auctions that had more than 200 lots.  

```{r fig.height = 4, fig.width = 6}

##Clevelend dot plot
MyData2 <-  strtrim(art_final$auc_title, 40)
art_final$auc_title <- MyData2

MyData1 <- art_final[!duplicated(art_final$auc_title),]

MyData3 <- subset(MyData1, select=c("auc_title", "number_of_lots"))

MyData3$auc_title <- factor(MyData3$auc_title, levels = MyData3$auc_title[order(MyData3$number_of_lots)])

MyData3<-  MyData3[which(MyData3$number_of_lots>200),]

ggplot(MyData3, aes( x = auc_title, y = number_of_lots)) + geom_point(stat="identity",  color="red") + coord_flip()+ theme_minimal() +labs(y = "Number of lots by auction")+labs(x = "Number of lots") + ggtitle("Auction title") + theme(plot.title = element_text(hjust = 0.5,face="bold"))

```

Based on the graph we identified the theme of each auction and calculated shares of different themes. The result showed that 48% of the auctions with the highest number of lots are Contemporary auctions. This results can be easily explained since modern artists create more and more content every year while for older masters artworks are main resold (nothing new is generated).

To conclude exploration of data we created a parallel coordinate plot for auction year, birth year of the artist, lot number in the auction, and hammer price colored by location.

```{r fig.height = 4, fig.width = 8}

MyDatas <-subset(art_final, select=c( "nth_in_auction", "auc_year" , "birth_year", "hammer_price_bp_usd", "location"))


library(GGally)
ggparcoord(MyDatas, columns = 1:(ncol(MyDatas)-1), scale = "uniminmax", groupColumn = "location", alphaLines =0.2) 

```

```{r fig.height = 4, fig.width =10}
#devtools::install_github("timelyportfolio/parcoords")
library(parcoords)
#library(httpuv)

parcoords(MyDatas,
    rownames = F 
    , brushMode = "1D-axes", alpha =0.5,color = list(
      colorBy = "location", colorScale = htmlwidgets::JS("d3.scale.category10()"))
    ) 
```


## Do Certain Lot Attributes Result in Higher Price?
### Lot Titles
#### What lots have higher price? 

To begin the analysis, we want to see the titles of expensive lots and plot their size with respect to the prices.

```{r}
df1 <- art_final
df_wordcloud <- df1[,c("lot_title","hammer_price_bp_usd")]
df_wordcloud <- arrange(df_wordcloud,desc(df_wordcloud$hammer_price_bp_usd))[1:1000,]
library(wordcloud)
library(tm)
pal <- brewer.pal(9, "OrRd")
pal <- pal[-(1:3)]
wordcloud(df_wordcloud$lot_title, min.freq = 10,df_wordcloud$hammer_price_bp_usd, scale=c(5, .5), random.order = FALSE, random.color = FALSE, colors= pal)
```

A lot of expensive lots appear to have "untitled" in their title. To get a better idea of what words artists tend to name their pieces, we count the frequency of each word appear in all titles and see which words do artists tend to use in the titles.

#### What words appear more often in the lot titles?
```{r}
# collapse the lot_title column by word and count the frequency they appear in the titles.
temp <- paste(df1$lot_title, collapse=' ' )
temp <- tolower(temp)
temp <- gsub(" *\\b[[:alpha:]]{1}\\b *", " ", temp)
temp <- gsub('[[:punct:] ]+',' ',temp)
temp <- as.list(strsplit(temp, " "))
temp <- unlist(temp)[!(unlist(temp) %in% stopwords("english"))]
temp <- unlist(temp)[!(unlist(temp) %in% "na")]
word_count <- na.omit(as.data.frame(table(temp)))
word_count <- arrange(word_count,desc(word_count$Freq))[1:300,]

# visualize word frequencies
pal <- brewer.pal(9, "Dark2")
wordcloud(word_count$temp, word_count$Freq, min.freq =20, scale=c(5, .5), random.order = FALSE, random.color = FALSE, colors= pal)
```

Without surprise, "untitled" indeed are the most popular word artists tend to use. In that case, are "untitled" works more likely to receive higher prices?

#### Looking at lots that have name "Untitled", what price ranges are they in? Is it correlated?

```{r}
library(vcd)
df1 <- df1 %>% 
  dplyr::mutate(hammer_price_bp_usd_range = forcats::fct_relevel(hammer_price_bp_usd_range, "<$50,000"))%>%
  dplyr::mutate(hammer_price_bp_usd_range = forcats::fct_relevel(hammer_price_bp_usd_range, "<$500,000"))%>%
   dplyr::mutate(hammer_price_bp_usd_range = forcats::fct_relevel(hammer_price_bp_usd_range, "$500,000+"))

vcd::mosaic(hammer_price_bp_usd_range~is_untitled, direction = c("v", "h"),df1,
       gp = gpar(fill = c("lightyellow", "lightpink")),
                 labeling = labeling_border(rot_labels = c(0, 45),pos_labels="center"))
```

In the above plot, "1" indicates the lot has "untitled" in it and "0" otherwise. Analyzing the mosaic plot above, we can see that "untitled" actually result in a relatively lower price as less "untitled" lots are in the range "$500,000+" while more "untitled" lots are in the lowest range. If the higher prices cannot explain the common use of "untitled", what can?

We guess that contemporary  artists tend to name their arts "untitled". To explore this, we put together the auction titles where "untitled" works are presented the most and labeled them with art type. 

#### Are "untitled" work mostly contemprary? 

```{r, fig.width=5}
untitle_ratio = read.csv("untitle_ratio.csv", header=TRUE)
#tempstr <-  strtrim(untitle_ratio$auc_title, 20)
#untitle_ratio$auc_title <- tempstr
untitle_ratio$is_contemporary = as.factor(untitle_ratio$is_contemporary)
ggplot(data=untitle_ratio, aes(x=reorder(auc_title,ratio), y=ratio,fill=is_contemporary))+geom_bar(stat="identity")+coord_flip() + xlab("Auction Title") + ylab("Ratio") +ggtitle("Auction Titles Based on their Ratio of Occurance")
```

Of the top 20 auctions that have highest "untitled" ratio, we see that contemporary auction is just slightly more than non-contemporary auction. In fact, by looking at auction names of non-contemporary auctions, we realize that smaller pieces of art (such as decoration, furnitures) tend to have "untitled" in their title as well! Perhaps those contribute mostly to the fact that "untitled" work have relatively lower price.

### Does the era of the lot affect its price?

Here, we will plot the hammer price against artists' birth years. Note that we are using log scales on the y-axis as the range of prices is wide.

```{r }
df3 <- df1 %>% 
  filter(df1$birth_year>1700)
ggplot(df3, aes(birth_year,hammer_price_bp_usd))  + 
  geom_smooth(method='lm',formula=y ~ poly(x, 3))+
  geom_point(alpha = .1)  + 
  theme_grey(10)+scale_y_log10()+  geom_density_2d(bins = 5)
```

From the above chart, we can see that modern pieces have larger variance. We'd like to try a boxplot to capture this feature.

```{r}
#box plot price vs year
ggplot(df3, aes(auth_era, hammer_price_bp_usd)) +
  geom_boxplot()+theme(axis.text.x = element_text(angle = 90, hjust = 1))+scale_y_log10() +xlab("Author's Era") +ylab("Price") +ggtitle("Author's Era vs Price of Their Work")
```

We notice that for certain era (e.g. 1750), there are no pieces sold. There are also more outliers for authors born 1900 - 1980. However, due to the complex change in average price over every 10 years, this box plot looks messy overall. Therefore, we decide to only include the scatter plot as that contains the information more straightforward.

## Do Certain Extrernal Factors Result in Higher Price?

###Does the Order Matter?

In general, there are a lot of lots in each auction. In our dataset, the average lot numbers per auction is 357. With the large amount of lots being auctioned, we assume that the most valuable pieces get presented early in the auction. To validate this idea, we normalized the order of lots presented in each auction and plot it against the hammer price.

```{r}
ggplot(df1, aes(percent_in_auction,hammer_price_bp_usd))  + 
  geom_smooth(method='lm',formula=y~x,color="red")+
  geom_point(alpha = .05)  + 
  theme_grey(10)+scale_y_log10()+
  facet_wrap(~location)
```

### Is there an impact from the financial crisis?


Let's start by looking at the average lot prices of Sothebeys on a monthly scale.

```{r}
df1$auc_ymd <- as.Date(df1$auc_year_month_date)
art_yearfin <- df1 %>% group_by(month=lubridate::floor_date(auc_ymd, "month")) %>% summarise(revenue = mean(hammer_price_bp_usd))
ggplot() +geom_line(data=art_yearfin, aes(x=month, y=revenue/1000000))+ggtitle("Financial Crisis' Effect on average lot price ($M)")+ylab("Average Price ($M)")+xlab("Year")+theme(axis.text.x = element_text(angle = 45, hjust = 1))+scale_y_log10() +theme_bw()
```

It appears that the monthly scale is not very helpful in determining the effect because of the different fluctuations around each auction. Perhaps looking at the average price with a little less granularity will help? Since the monthly scale appears to have too much "noise," we will redraw the graph looking at a yearly scale instead. Our guess is that we are supposed to see a significant drop around the time of the financial crisis. 

```{r}
art_finance <- art_final[c("auc_year", "auc_month", "location","hammer_price_bp_usd")] %>% filter(!is.na(hammer_price_bp_usd))
art_yearfin <- art_finance %>% group_by(auc_year) %>% summarise(av_revenue =mean(hammer_price_bp_usd))
ggplot(art_yearfin, aes(x=auc_year, y=as.numeric(av_revenue/1000000))) +geom_line(col="darkblue")+ggtitle("Financial Crisis' Effect on Average Auction Price ($M)")+ylab("Average Price ($M)")+xlab("Year") +theme_bw()
```

Indeed, we are seeing a big dip around late 2010. It may be surprising to see that it took some time for the effect to reach the auction houses. Nonetheless, when thinking back on the world-wide timeline of the Financial Crisis' effect, it did take a few years for it to reach other industries outside of finance. 

Next, let us explore the same effect on the total revenue and see if the same pattern holds.

```{r}
art_finance <- art_final[c("auc_year", "auc_month", "location","hammer_price_bp_usd")] %>% filter(!is.na(hammer_price_bp_usd))
art_yearfin <- art_finance %>% group_by(auc_year) %>% summarise(revenue = sum(hammer_price_bp_usd))
ggplot(art_yearfin, aes(x=auc_year, y=as.numeric(revenue/1000000))) +geom_line(col="darkblue")+ggtitle("Financial Crisis' Effect on Auction Revenue ($M)")+ylab("Revenue ($M)")+xlab("Year")+theme_bw()
```

We can easily tell that the two graphs are very similar and the total revenue did experience the same drop. Perhaps there are certain locations that are skewing some of the data. Let us try to facet the data by location and see if that could present us with a better outlook. We will be excluding Dubai and Doha due to lack of data for hammer prices (as shows in the data quality part).

```{r}
art_locfin <- art_finance %>% group_by(auc_year, location) %>% summarise(av_revenue = mean(hammer_price_bp_usd)) %>% filter(location %in%  c("NEW YORK", "LONDON", "PARIS", "MILAN"))
ggplot(art_locfin, aes(x=auc_year, y=as.numeric(av_revenue/1000000))) +geom_line(col="darkblue")+ggtitle("Financial Crisis' Effect on Average Auction Price ($M)")+ylab("Average Price ($M)")+xlab("Year") + facet_wrap(~location, scales ="free_y")+theme_bw()
```

We notice a consistent drop in revenue across all locations above starting 2010. Therefore, our original hypothesis must be correct: the financial crisis did have an effect on the auction revenue across the world (specifically significant drops are observed in New York and Hong Kong). 

###Does Season Matter?

```{r}
df1 <- df1 %>% 
  dplyr::mutate(auc_season = forcats::fct_relevel(auc_season, "summer")) %>%
  dplyr::mutate(auc_season = forcats::fct_relevel(auc_season, "fall")) %>%
  dplyr::mutate(auc_season = forcats::fct_relevel(auc_season, "winter"))
vcd::mosaic(hammer_price_bp_usd_range~auc_season, direction = c("v", "h"),df1,
       gp = gpar(fill = c("yellow", "purple")),
                 labeling = labeling_border(rot_labels = c(0, 90),pos_labels="center"))
```

The labels of hammer price range did not turn out as neat in the beginning, however, after changing the order of the seasons, we obtained the above graph indicating the clear correlations between seasons and the lot prices. Specifically, there are more lots sold in spring and fall and lots are sold relatively higher in the fall.

###Does Location Matter?

```{r}
# Elizabet bar plot
```

# Executive Summary

The explatory visualization part of the project allowed us to dive deep around our original questions of interest. We used the main analysis to narrow down some of the most interesting findings in relation to our dataset.

Next, we will present these findings with graphs in following summary:

## 1. Art pieces created in the 20th centry on average are sold at a higher price.

There are more lots sold where their authors are born in the 20th century, specifically in 1900s,1930s and 1960s. For simplicity, we call them "modern" pieces and call the lots whose authors were born before 1900 "older" pieces. From the graph, we can see that modern pieces have higher prices on average while having larger variance too. One plausible explanation is that the price range and values for contemporary art are more likely to uneven due to the nature of the contemporary art.

```{r ECHO=FALSE}
df3 <- df2 %>% 
  filter(df2$birth_year>1700)
ggplot(df3, aes(birth_year,hammer_price_bp_usd))  + 
  geom_smooth(method='lm',formula=y ~ poly(x, 3),color="orange")+
  geom_point(alpha = .1)  + 
  theme_bw()+scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x)))+geom_density_2d(bins = 5, color="orange")+
    scale_x_continuous(breaks = seq(min(df3$birth_year), max(df3$birth_year),10))+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  xlab("Author Birth Year")+
  ylab("Hammer Price")+
  ggtitle("Lot Hammer Price vs Author Birth Year")
```

## 2. The earlier the lots get presented in an auction, the higher price they have.

Due to large number of lots presented in Sotheby's auctions, the most valuable pieces get presented early on in the auction. From the below graph, we conclude that there is a negative relationship between art prices and order presented for all locations besides Dubai. Particularly Paris has the most obvious negative relationship.

```{r}
ggplot(df3, aes(percent_in_auction,hammer_price_bp_usd))  + 
  geom_smooth(method='lm',formula=y~x,color="orange")+
  geom_point(alpha = .05)  + 
  theme_grey(10)+scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  facet_wrap(~location)+
  theme_bw()+
  xlab("Lot Order in Auction")+
  ylab("Hammer Price")+
  ggtitle("Lot Hammer Price vs Lot Order in Auction")
```
## 3. Lot prices are closely related to season.

Most of the auctions appear in March and November, thus in the graph we see fall and spring have more lots being sold. Aside from the quantity, the price of the lots are closely related to season as well. We conclude that winter has a positive correlation for lots to be sold in the highest range ($500,000+) as well as the lowest range (<$10,000). Lots sold in Fall, however, appear more likely to fall in the higher price ranges. Lots sold in spring are relatively cheaper compared to lots sold in other seasons.

```{r}
df1$Hammer_Price_Range <- df1$hammer_price_bp_usd_range
df1$Auction_Season <- df1$auc_season
vcd::mosaic(Hammer_Price_Range~Auction_Season, direction = c("v", "h"),df1,
       gp = gpar(fill = c("yellow", "purple")),
                 labeling = labeling_border(rot_labels = c(0, 90),pos_labels="center"))
```

## 4. Conclusion about location

## 5. Financial Crisis had a negative effect on average price across almost all locations around the world

By looking at the graph, one can see how each location experienced a significant drop in average price approximately 2-3 years after the initial Financial Crisis hit in 2008. While some locations have a stronger and clearer trend than other, the directional conclusion stays the same. Some locations like New York and London lost close or even more than 50% of value (average price) during that time. 

```{r ECHO=FALSE}
art_locfin <- art_finance %>% group_by(auc_year, location) %>% summarise(av_revenue = mean(hammer_price_bp_usd)) %>% filter(location %in%  c("NEW YORK", "LONDON", "PARIS", "MILAN"))
ggplot(art_locfin, aes(x=auc_year, y=as.numeric(av_revenue/1000000))) +geom_line(col="darkblue")+ggtitle("Financial Crisis' Effect on Average Auction Price ($M)")+ylab("Average Price ($M)")+xlab("Year") + facet_wrap(~location, scales ="free_y")+theme_bw()
```

In addition, it is important to notice the major climb in prices around 2012-2013. This observation goes in support with our original hypothesis that investors began putting more money into art as a new form of investment after the financial crisis. In all locations (with an exception of Paris), the average lot price has recovered and surpassed the one before the crisis. 

# Interactive Componenet

Link to the interactive part: https://edav-art-viz.firebaseapp.com

### Description ### 

This view allows users to see all of the lots sold by their price and timeframe. Each color also represents a different location. This visualization supports the project's main hypothesis that location and season significantly affect the auction performance.

### Instructions ### 

There are quite a few great aspect of this chart that could be very helpful for the user:

1. **Change Year** - Click on the arrows next to the year to either move a year forward or backwards. This can help to compare the different distributions and average price of lots across all years in our dataset.
2. **See Lot Details** - Hover over each circle to see the details of the lot transaction. You should expect to see a window that is showing the hammer price as well as the picture of the lot. Keep in mind that a lot of the lots have their pictures protected by the copyright (so they will not show). Nonetheless, some of the later ones typicaally do:)
2.  **Spread Data Points ** - to better see each data point for the details, use the button on the top right that says: "Jitter" This would jitter the points from their original location to better see all options. One can easily bring the points back to proper location by unclicking the button.
